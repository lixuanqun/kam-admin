# Kamailio Docker 配置：启用 JSONRPC + MySQL，供 kam-admin 调用
# 数据库连接由环境变量 DBURL 注入，默认 mysql://kamailio:kamailiorw@mysql:3306/kamailio

#!KAMAILIO
#!define DBURL "mysql://kamailio:kamailiorw@mysql:3306/kamailio"

log_level=2
log_stderror=no

# 核心模块
loadmodule "kex.so"
loadmodule "corex.so"
loadmodule "cfg_rpc.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "tm.so"
loadmodule "tmx.so"
loadmodule "sl.so"
loadmodule "xhttp.so"
loadmodule "jsonrpcs.so"

# 数据库
loadmodule "db_mysql.so"

# 常用业务模块（供 RPC 与 kam-admin 管理）
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "domain.so"
loadmodule "permissions.so"
loadmodule "dispatcher.so"
loadmodule "drouting.so"
loadmodule "dialog.so"
loadmodule "htable.so"
loadmodule "acc.so"
loadmodule "rtpengine.so"

# 模块参数
modparam("jsonrpcs", "pretty_format", 1)
modparam("jsonrpcs", "transport", 1)
# RTPengine：连接 Docker 中的 rtpengine 服务
modparam("rtpengine", "rtpengine_sock", "udp:rtpengine:22222")
modparam("rtpengine", "db_url", DBURL)
modparam("usrloc", "db_url", DBURL)
modparam("registrar", "db_url", DBURL)
modparam("domain", "db_url", DBURL)
modparam("permissions", "db_url", DBURL)
modparam("dispatcher", "db_url", DBURL)
modparam("drouting", "db_url", DBURL)
modparam("dialog", "db_url", DBURL)
modparam("htable", "db_url", DBURL)
modparam("acc", "db_url", DBURL)

listen=tcp:0.0.0.0:5060

event_route[xhttp:request] {
    if ($hu =~ "^/RPC") {
        jsonrpc_dispatch();
        exit;
    }
    xhttp_reply("200", "OK", "text/html", "Kamailio JSONRPC ready");
}

request_route {
    exit;
}
