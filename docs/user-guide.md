# 用户管理操作手册

## 概述

用户管理模块用于管理 Kamailio SIP 用户账号，包括用户的增删改查、域管理、用户别名、用户组等功能。

---

## 1. 用户管理 (/kamailio/subscribers)

### 1.1 查看用户列表

1. 进入 **Kamailio 管理 > 用户管理**
2. 页面显示所有 SIP 用户列表
3. 支持按用户名搜索

### 1.2 新增用户

1. 点击 **新增** 按钮
2. 填写表单：
   - **用户名**: SIP 用户名（必填）
   - **域**: SIP 域（必填）
   - **密码**: 登录密码（必填）
   - **邮箱**: 用户邮箱（可选）
   - **RPID**: 远程方标识（可选）
3. 点击 **确定** 保存

> 注意：密码会自动计算 HA1 和 HA1B 哈希值存储

### 1.3 修改用户

1. 在用户列表中找到目标用户
2. 点击 **编辑** 按钮
3. 修改需要更改的字段
4. 点击 **确定** 保存

### 1.4 删除用户

1. 在用户列表中找到目标用户
2. 点击 **删除** 按钮
3. 确认删除操作

### 1.5 相关数据库表

| 表名 | 说明 |
|------|------|
| subscriber | 存储 SIP 用户信息 |

### 1.6 相关字段说明

| 字段 | 说明 |
|------|------|
| username | SIP 用户名 |
| domain | SIP 域 |
| password | 明文密码（根据配置可能不存储） |
| ha1 | MD5(username:realm:password) |
| ha1b | MD5(username@domain:realm:password) |
| email_address | 邮箱地址 |
| rpid | 远程方标识 |

---

## 2. 域管理 (/kamailio/domains)

### 2.1 查看域列表

1. 进入 **Kamailio 管理 > 域管理**
2. 页面显示所有配置的域

### 2.2 新增域

1. 点击 **新增** 按钮
2. 填写：
   - **域名**: 如 `example.com`
   - **描述**: 域的描述信息
3. 点击 **确定**

### 2.3 重载域配置

1. 点击 **重载配置** 按钮
2. 系统会调用 Kamailio RPC 重新加载域配置

> 提示：修改域配置后需要重载才能生效

### 2.4 相关 RPC 指令

```
domain.reload - 重新加载域配置
domain.dump - 导出当前域配置
```

---

## 3. 用户数据 (/kamailio/userdata)

### 3.1 用户别名

用户别名允许一个用户拥有多个 SIP URI。

**新增别名：**

1. 进入 **用户数据** 页面，选择 **用户别名** 标签
2. 点击 **新增**
3. 填写：
   - **别名用户名**: 别名的用户名部分
   - **别名域**: 别名的域部分
   - **真实用户名**: 实际用户
   - **真实域**: 实际域
4. 保存

**使用场景：**
- 一个用户有多个分机号
- 用户有多个联系方式

### 3.2 用户组

用户组用于对用户进行分组管理，可用于权限控制。

**新增用户组关联：**

1. 选择 **用户组** 标签
2. 点击 **新增**
3. 填写用户名、域和组名
4. 保存

**使用场景：**
- 区分内部用户和外部用户
- 权限分级管理

### 3.3 快捷拨号

快捷拨号允许用户使用短号拨打。

**相关数据库表：**

| 表名 | 说明 |
|------|------|
| dbaliases | 用户别名 |
| grp | 用户组 |
| speed_dial | 快捷拨号 |

---

## 4. 用户偏好设置 (/kamailio/usrpreferences)

### 4.1 功能说明

用户偏好设置用于存储用户级别的配置参数，如：
- 呼叫转移设置
- 免打扰状态
- 自定义参数

### 4.2 新增偏好

1. 进入 **用户偏好设置** 页面
2. 点击 **新增**
3. 填写：
   - **UUID**: 唯一标识（可选）
   - **用户名**: 用户名
   - **域**: 域
   - **属性**: 属性名称（如 `cfb`, `cfu`）
   - **类型**: 值类型（0=字符串, 1=整数）
   - **值**: 属性值
4. 保存

### 4.3 常用属性

| 属性 | 说明 | 示例值 |
|------|------|--------|
| cfu | 无条件呼叫转移 | sip:1001@domain |
| cfb | 遇忙呼叫转移 | sip:1002@domain |
| cfna | 无应答呼叫转移 | sip:1003@domain |
| dnd | 免打扰 | 1 |

---

## 5. UAC 注册 (/kamailio/uac)

### 5.1 功能说明

UAC 注册用于 Kamailio 作为 UAC 向远程服务器注册，常用于：
- 与 PSTN 网关对接
- 与其他 SIP 服务器互联
- 中继线路注册

### 5.2 新增 UAC 注册

1. 进入 **UAC 注册** 页面
2. 点击 **新增**
3. 填写：
   - **L UUID**: 本地唯一标识
   - **L 用户名/域**: 本地 SIP 地址
   - **R 用户名/域**: 远程 SIP 地址
   - **认证用户名**: 注册认证用户名
   - **认证密码**: 注册认证密码
   - **认证代理**: 远程服务器地址
   - **过期时间**: 注册有效期（秒）
4. 保存

### 5.3 管理操作

| 操作 | 说明 |
|------|------|
| 重载 | 重新加载所有 UAC 注册配置 |
| 刷新 | 刷新指定注册 |
| 导出内存 | 查看当前内存中的注册状态 |

### 5.4 相关 RPC 指令

```
uac.reg_reload - 重载注册配置
uac.reg_info <l_uuid> - 获取注册信息
uac.reg_refresh <l_uuid> - 刷新注册
uac.reg_dump - 导出所有注册
```

---

## 6. 最佳实践

### 6.1 用户命名规范

- 使用数字或字母组合作为用户名
- 用户名长度建议 4-20 字符
- 避免使用特殊字符

### 6.2 密码安全

- 密码长度至少 8 位
- 包含数字、字母和特殊字符
- 定期更换密码

### 6.3 批量操作

对于大量用户的管理，建议：
- 使用数据库直接导入
- 开发批量导入功能
- 使用 CSV 文件管理

---

## 7. 故障排查

### 用户无法注册

1. 检查用户名和密码是否正确
2. 检查域配置是否存在
3. 查看 Kamailio 日志

### 用户认证失败

1. 检查 HA1/HA1B 是否正确计算
2. 确认 realm 配置
3. 检查密码是否包含特殊字符
