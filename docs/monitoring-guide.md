# 监控管理操作手册

## 概述

监控管理模块用于实时监控 Kamailio 的运行状态，包括用户注册、活动对话、SIP 消息跟踪、CDR 记录等功能。

---

## 1. 注册监控 (/kamailio/locations)

### 1.1 功能说明

注册监控用于查看当前在线的 SIP 用户及其注册信息。

### 1.2 查看注册用户

1. 进入 **注册监控** 页面
2. 页面显示所有当前注册的用户
3. 支持按用户名搜索

### 1.3 注册信息字段

| 字段 | 说明 |
|------|------|
| 用户名 | SIP 用户名 |
| 域 | SIP 域 |
| 联系地址 | 用户的 Contact 地址 |
| 过期时间 | 注册过期时间 |
| User-Agent | 客户端信息 |
| 接收来源 | 实际接收到注册请求的 IP |
| Socket | 使用的本地 Socket |

### 1.4 管理操作

| 操作 | 说明 |
|------|------|
| 刷新 | 刷新注册列表 |
| 从内存加载 | 从 Kamailio 内存获取最新数据 |
| 删除联系 | 删除指定用户的注册 |

### 1.5 相关 RPC 指令

```
ul.dump - 导出所有注册
ul.lookup <table> <aor> - 查找指定用户
ul.rm <table> <aor> - 删除用户注册
ul.rm_contact <table> <aor> <contact> - 删除指定联系地址
```

---

## 2. 对话管理 (/kamailio/dialogs)

### 2.1 功能说明

对话管理用于监控当前活动的 SIP 对话（正在进行的通话）。

### 2.2 查看活动对话

1. 进入 **对话管理** 页面
2. 上方显示统计信息
3. **活动对话（内存）** 显示当前正在进行的通话
4. **对话记录（数据库）** 显示历史对话记录

### 2.3 对话信息字段

| 字段 | 说明 |
|------|------|
| Hash Entry | 对话哈希表入口 |
| Hash ID | 对话 ID |
| Call ID | SIP Call-ID |
| From URI | 主叫 URI |
| To URI | 被叫 URI |
| 状态 | 对话状态 |

### 2.4 对话状态

| 状态 | 说明 |
|------|------|
| 1 | 初始状态 |
| 2 | 早期对话 |
| 3 | 已确认 |
| 4 | 已删除 |

### 2.5 结束对话

1. 在活动对话列表中找到目标对话
2. 点击 **结束** 按钮
3. 确认操作

> 注意：结束对话会向双方发送 BYE 消息

### 2.6 相关 RPC 指令

```
dlg.list - 列出所有活动对话
dlg.stats_active - 获取对话统计
dlg.end_dlg <h_entry> <h_id> - 结束指定对话
dlg.dlg_list - 获取对话详情
```

---

## 3. CDR 记录 (/kamailio/cdr)

### 3.1 功能说明

CDR（Call Detail Record）记录用于查看通话详单和未接来电记录。

### 3.2 查看 CDR

1. 进入 **CDR 记录** 页面
2. 选择 **CDR 记录** 或 **未接来电** 标签
3. 使用筛选条件搜索

### 3.3 筛选条件

| 条件 | 说明 |
|------|------|
| 主叫用户 | 发起呼叫的用户 |
| 被叫用户 | 接收呼叫的用户 |
| Call ID | SIP Call-ID |
| 开始时间 | 时间范围开始 |
| 结束时间 | 时间范围结束 |
| SIP 状态码 | 响应状态码 |

### 3.4 CDR 字段说明

| 字段 | 说明 |
|------|------|
| method | SIP 方法（INVITE, BYE 等） |
| callid | 呼叫唯一标识 |
| sip_code | SIP 响应码 |
| sip_reason | SIP 响应原因 |
| time | 记录时间 |
| src_user | 主叫用户 |
| dst_user | 被叫用户 |
| src_ip | 主叫 IP |

### 3.5 统计信息

页面顶部显示统计信息：
- 今日呼叫总数
- 成功呼叫数
- 失败呼叫数
- 未接来电数

---

## 4. SIP 跟踪 (/kamailio/siptrace)

### 4.1 功能说明

SIP 跟踪用于记录和查看 SIP 消息，便于问题排查和调试。

### 4.2 查看跟踪记录

1. 进入 **SIP 跟踪** 页面
2. 使用筛选条件搜索
3. 点击记录查看详情

### 4.3 筛选条件

| 条件 | 说明 |
|------|------|
| Call ID | SIP Call-ID |
| 跟踪用户 | 被跟踪的用户 |
| 方法 | SIP 方法（INVITE, REGISTER 等） |
| From IP | 来源 IP |
| To IP | 目标 IP |

### 4.4 查看呼叫流程

1. 在列表中点击 **查看** 按钮
2. 弹窗显示该 Call-ID 的所有 SIP 消息
3. 按时间顺序展示完整的呼叫流程

### 4.5 SIP 跟踪配置

在 Kamailio 配置中启用 SIP 跟踪：

```
loadmodule "siptrace.so"

modparam("siptrace", "db_url", "mysql://kamailio:password@localhost/kamailio")
modparam("siptrace", "trace_on", 1)
modparam("siptrace", "trace_flag", 22)

# 在路由中启用跟踪
route {
    setflag(22);
    sip_trace();
    ...
}
```

### 4.6 清理旧记录

1. 点击 **清理** 按钮
2. 默认清理 30 天前的记录
3. 确认操作

---

## 5. 拓扑隐藏 (/kamailio/topos)

### 5.1 功能说明

拓扑隐藏（Topos）用于隐藏内部网络拓扑，查看拓扑隐藏的对话记录。

### 5.2 查看记录

1. 进入 **拓扑隐藏** 页面
2. 查看当前的拓扑隐藏对话

### 5.3 清理记录

1. 点击 **清理** 按钮
2. 默认清理 7 天前的记录

---

## 6. 存在服务 (/kamailio/presence)

### 6.1 功能说明

存在服务用于管理用户的在线状态订阅和通知。

### 6.2 Presentity

Presentity 是发布状态的实体：

| 字段 | 说明 |
|------|------|
| 用户名 | 发布者用户名 |
| 域 | 发布者域 |
| 事件 | 事件类型（presence, dialog 等） |
| 过期时间 | 状态过期时间 |

### 6.3 Watchers

Watchers 是订阅状态的实体：

| 字段 | 说明 |
|------|------|
| Presentity URI | 被订阅的 URI |
| Watcher | 订阅者 |
| 事件 | 订阅的事件类型 |
| 状态 | 订阅状态 |

### 6.4 清理过期数据

点击 **清理过期** 按钮清理过期的 Presentity 和 Watcher 记录。

### 6.5 相关 RPC 指令

```
presence.cleanup - 清理过期记录
presence.refreshWatchers <uri> <event> - 刷新订阅者
```

---

## 7. 离线消息 (/kamailio/msilo)

### 7.1 功能说明

离线消息用于存储发送给离线用户的消息，待用户上线后投递。

### 7.2 查看离线消息

1. 进入 **离线消息** 页面
2. 查看待投递的消息列表

### 7.3 消息字段

| 字段 | 说明 |
|------|------|
| 源地址 | 发送者地址 |
| 目标地址 | 接收者地址 |
| 存储时间 | 消息存储时间 |
| 过期时间 | 消息过期时间 |
| 内容类型 | 消息内容类型 |

### 7.4 管理操作

| 操作 | 说明 |
|------|------|
| 删除 | 删除指定消息 |
| 清理过期 | 清理所有过期消息 |

---

## 8. 监控面板 (/kamailio/monitoring)

### 8.1 功能说明

监控面板提供系统整体状态概览。

### 8.2 面板内容

- **系统状态**: Kamailio 运行状态
- **注册用户数**: 当前在线用户数量
- **活动对话数**: 正在进行的通话数量
- **今日呼叫**: 今日呼叫统计

### 8.3 健康检查

自动检查以下项目：
- Kamailio 进程状态
- 数据库连接
- RPC 接口可用性

---

## 9. 监控最佳实践

### 9.1 日常巡检

1. 检查系统健康状态
2. 查看异常的注册和对话
3. 关注错误统计

### 9.2 问题排查流程

1. 获取问题呼叫的 Call-ID
2. 在 SIP 跟踪中搜索
3. 分析完整的呼叫流程
4. 定位问题原因

### 9.3 数据清理策略

| 数据类型 | 建议保留时间 |
|---------|-------------|
| SIP 跟踪 | 7-30 天 |
| CDR 记录 | 90-365 天 |
| 对话记录 | 30-90 天 |
| 离线消息 | 7 天 |

---

## 10. 故障排查

### 看不到注册用户

1. 检查用户是否已注册
2. 检查 usrloc 模块配置
3. 尝试从内存加载数据

### CDR 记录不完整

1. 检查 acc 模块配置
2. 确认 acc_db_url 配置正确
3. 检查数据库表结构

### SIP 跟踪无数据

1. 检查 siptrace 模块是否加载
2. 确认 trace_on 参数为 1
3. 检查路由中是否调用 sip_trace()
