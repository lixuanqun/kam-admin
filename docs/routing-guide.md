# 路由管理操作手册

## 概述

路由管理模块用于配置 Kamailio 的呼叫路由规则，包括调度器、动态路由、LCR 路由、运营商路由、拨号计划等功能。

---

## 1. 调度器管理 (/kamailio/dispatchers)

### 1.1 功能说明

调度器（Dispatcher）用于将请求分发到多个目标服务器，实现负载均衡和故障转移。

### 1.2 新增调度目标

1. 进入 **调度器** 页面
2. 点击 **新增**
3. 填写：
   - **Set ID**: 调度组 ID（整数）
   - **目标地址**: SIP URI，如 `sip:192.168.1.100:5060`
   - **标志**: 调度标志
   - **优先级**: 优先级（数字越小优先级越高）
   - **权重**: 权重值（用于加权分发）
   - **描述**: 描述信息
4. 保存

### 1.3 调度算法

| 算法 | 标志值 | 说明 |
|------|--------|------|
| 轮询 | 0 | Round-Robin |
| 哈希（Call-ID） | 1 | 基于 Call-ID 哈希 |
| 哈希（From URI） | 2 | 基于 From URI 哈希 |
| 哈希（To URI） | 3 | 基于 To URI 哈希 |
| 哈希（Request URI） | 4 | 基于 Request URI 哈希 |
| 随机 | 5 | 随机选择 |
| 基于权重 | 6 | 加权随机 |
| 基于优先级 | 7 | 优先级选择 |
| 哈希（Authorization） | 8 | 基于认证头哈希 |

### 1.4 管理操作

| 操作 | 说明 |
|------|------|
| 重载 | 重新加载调度器配置 |
| 查看状态 | 获取当前调度器状态 |

### 1.5 相关 RPC 指令

```
dispatcher.reload - 重载配置
dispatcher.list - 列出所有调度组
dispatcher.set_state - 设置目标状态
```

---

## 2. 动态路由 (/kamailio/drouting)

### 2.1 功能说明

动态路由（DRouting）提供灵活的路由规则配置，支持：
- 基于号码前缀的路由
- 多网关故障转移
- 基于时间的路由

### 2.2 网关管理

**新增网关：**

1. 进入 **动态路由** 页面，选择 **网关** 标签
2. 点击 **新增**
3. 填写：
   - **网关 ID**: 唯一标识符
   - **地址**: 网关 SIP 地址，如 `sip:10.0.0.1:5060`
   - **类型**: 网关类型（自定义）
   - **剥离位数**: 发送前剥离的号码位数
   - **前缀**: 添加的号码前缀
   - **状态**: 0=启用, 1=禁用
   - **描述**: 描述信息
4. 保存

**网关地址格式：**

```
sip:IP:PORT
sip:IP:PORT;transport=tcp
sip:domain
```

### 2.3 路由规则

**新增规则：**

1. 选择 **规则** 标签
2. 点击 **新增**
3. 填写：
   - **分组 ID**: 规则所属分组
   - **前缀**: 匹配的号码前缀
   - **优先级**: 规则优先级
   - **网关列表**: 使用的网关，格式 `gw1,gw2,gw3`
   - **时间规则**: 时间条件（可选）
   - **描述**: 规则描述
4. 保存

**网关列表格式：**

```
# 简单列表（按顺序尝试）
gw1,gw2,gw3

# 带权重
gw1=50,gw2=30,gw3=20

# 运营商列表
#cr1,#cr2
```

### 2.4 时间规则格式

```
# 工作日 9:00-18:00
wday=1-5;hour=9-18

# 周末全天
wday=6-7

# 每天晚上
hour=18-23
```

### 2.5 相关 RPC 指令

```
drouting.reload - 重载配置
drouting.gw_status - 获取网关状态
drouting.carrier_status - 获取运营商状态
```

---

## 3. LCR 路由 (/kamailio/lcr)

### 3.1 功能说明

LCR（Least Cost Routing）最低成本路由用于根据号码选择最便宜的路由。

### 3.2 LCR 网关

1. 进入 **LCR 路由** 页面
2. 在 **网关** 标签查看和管理 LCR 网关
3. 新增网关填写：
   - **LCR ID**: LCR 实例 ID
   - **网关名**: 网关名称
   - **IP 地址**: 网关 IP
   - **端口**: SIP 端口
   - **传输协议**: 0=UDP, 1=TCP, 2=TLS
   - **标签**: 自定义标签

### 3.3 LCR 规则

规则定义号码前缀与网关的映射：

1. 选择 **规则** 标签
2. 新增规则填写：
   - **LCR ID**: LCR 实例 ID
   - **前缀**: 匹配的号码前缀
   - **From URI**: 来源 URI 匹配（可选）

### 3.4 LCR 目标

目标将规则与网关关联：

1. 选择 **目标** 标签
2. 新增目标填写：
   - **规则 ID**: 关联的规则
   - **网关 ID**: 关联的网关
   - **优先级**: 选择优先级
   - **权重**: 权重值

### 3.5 相关 RPC 指令

```
lcr.reload - 重载配置
lcr.dump_gws - 导出网关
lcr.dump_rules - 导出规则
```

---

## 4. 运营商路由 (/kamailio/carrierroute)

### 4.1 功能说明

运营商路由用于复杂的多运营商路由场景。

### 4.2 运营商配置

1. 在 **运营商** 标签添加运营商名称
2. 在 **域** 标签添加路由域
3. 在 **失败路由** 标签配置失败处理

### 4.3 失败路由

当主路由失败时的备选路由：

| 字段 | 说明 |
|------|------|
| 运营商 | 运营商 ID |
| 域 | 路由域 ID |
| 扫描前缀 | 匹配的前缀 |
| 回复码 | 触发失败路由的 SIP 回复码 |
| 下一个域 | 失败后尝试的域 |

### 4.4 相关 RPC 指令

```
cr.reload_routes - 重载路由配置
cr.dump_routes - 导出路由表
```

---

## 5. 拨号计划 (/kamailio/dialplan)

### 5.1 功能说明

拨号计划用于号码翻译和重写，如：
- 国际号码标准化
- 短号转长号
- 号码前缀添加/删除

### 5.2 新增规则

1. 进入 **拨号计划** 页面
2. 点击 **新增**
3. 填写：
   - **DPID**: 拨号计划 ID
   - **优先级**: 规则优先级
   - **匹配表达式**: 正则表达式
   - **替换表达式**: 替换模式
   - **替换结果**: 替换结果
4. 保存

### 5.3 示例规则

**去除国际前缀 00：**

| 字段 | 值 |
|------|-----|
| DPID | 1 |
| 匹配表达式 | ^00(.*)$ |
| 替换表达式 | \1 |
| 替换结果 | +\1 |

**短号转长号：**

| 字段 | 值 |
|------|-----|
| DPID | 2 |
| 匹配表达式 | ^8([0-9]{3})$ |
| 替换结果 | +8613800000\1 |

### 5.4 测试翻译

1. 点击 **测试** 按钮
2. 输入 DPID 和待翻译号码
3. 查看翻译结果

### 5.5 相关 RPC 指令

```
dialplan.reload - 重载配置
dialplan.translate <dpid> <input> - 测试翻译
dialplan.dump - 导出规则
```

---

## 6. 内存树 Mtree (/kamailio/mtree)

### 6.1 功能说明

Mtree 用于高效的前缀匹配，适用于：
- 黑名单号码匹配
- 号码归属地查询
- 快速路由查找

### 6.2 使用方法

1. 添加记录：指定树名、前缀和值
2. 重载配置使其生效
3. 在 Kamailio 脚本中使用 `mt_match()` 函数

### 6.3 相关 RPC 指令

```
mtree.reload <tname> - 重载指定树
mtree.match <tname> <prefix> - 测试匹配
mtree.summary - 获取统计信息
```

---

## 7. 前缀域转换 PDT (/kamailio/pdt)

### 7.1 功能说明

PDT 用于基于号码前缀选择目标域。

### 7.2 新增记录

1. 填写 SD 域（源域）
2. 填写前缀
3. 填写目标域
4. 保存并重载

### 7.3 相关 RPC 指令

```
pdt.reload - 重载配置
pdt.list - 列出所有规则
```

---

## 8. 路由配置最佳实践

### 8.1 高可用配置

1. 配置多个网关作为备份
2. 使用优先级和权重实现负载均衡
3. 启用健康检查自动剔除故障节点

### 8.2 路由规则设计

1. 从最具体的前缀开始配置
2. 使用优先级控制匹配顺序
3. 配置默认路由作为兜底

### 8.3 性能优化

1. 减少不必要的正则表达式
2. 使用 Mtree 替代复杂的前缀匹配
3. 定期清理过期的路由规则

---

## 9. 故障排查

### 路由不生效

1. 检查是否已重载配置
2. 检查规则优先级
3. 检查匹配条件是否正确

### 呼叫路由失败

1. 检查网关状态
2. 检查网关地址是否正确
3. 查看 Kamailio 日志
