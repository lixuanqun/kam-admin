# Kam-Admin 领域建模与子域划分

本文从 **领域驱动设计（DDD）** 视角说明 kam-admin 应有哪些子域、划分理由，以及如何兼顾当前实现与未来规划。

---

## 一、业务本质与限界上下文

**Kam-Admin** 的定位是：对 **Kamailio（SIP 服务器）** 进行配置、监控与运维的**管理后台**。

- **核心价值**：把 Kamailio 的 RPC、配置与数据通过统一控制台暴露，并叠加**用户/租户/权限/审计**等企业能力。
- **限界上下文**：整体可视为一个「**Kamailio 运维与配置**」上下文；其内再按业务内聚性划分子域，便于边界清晰、独立演进和未来按域拆服务。

因此，子域划分应同时满足：
1. **与 Kamailio 能力对齐**：管理后台的功能块与 Kamailio 模块（dispatcher、dialog、acc 等）自然对应，便于 RPC 与数据模型一一落地。
2. **符合 DDD 子域类型**：能区分核心域、支撑子域、通用子域，便于分配演进优先级和资源。
3. **为未来留空间**：多租户深化、开放 API、部分域独立成微服务、新能力（如策略引擎、计费策略）等。

---

## 二、推荐子域划分（DDD 视角）

| 子域 | 类型 | 职责 | 当前 Maven 模块 | 包含的 Kamailio 能力 |
|------|------|------|-----------------|----------------------|
| **路由与调度** | **核心域** | 呼叫路由、负载均衡、拨号计划、运营商/前缀路由等「话务怎么走」的配置与下发 | kam-admin-module-routing | dispatcher, drouting, lcr, carrierroute, dialplan, mtree, pdt |
| **会话与位置** | **核心域** | 对话/会话状态、内存表、用户位置注册与查询，决定「谁在哪、会话状态」 | kam-admin-module-session | dialog, htable, location |
| **用户与权限** | **支撑子域** | 用户/订阅者、域、权限、用户数据与偏好，支撑「谁能用、能看什么」 | kam-admin-module-user | subscriber, domain, permissions, userdata, usrpreferences |
| **监控与统计** | **支撑子域** | 运行监控、计费(acc)、版本与系统信息，支撑「看得见、可计费、可排障」 | kam-admin-module-monitor | monitoring, acc, version, system |
| **状态与消息** | **支撑/通用** | 在线状态、消息存储(msilo)、UAC 等，偏「状态与消息类」能力 | kam-admin-module-presence | presence, msilo, uac |
| **跟踪与安全** | **通用子域** | SIP 跟踪、拓扑、安全过滤、RTP 引擎等，偏运维与安全能力 | kam-admin-module-trace | siptrace, topos, secfilter, rtpengine |

**核心域**：路由与调度、会话与位置 —— 直接决定「通话如何路由、会话与位置如何管理」，是管理后台差异化与存在理由的核心。  
**支撑子域**：用户与权限、监控与统计、状态与消息 —— 业务必需，但可复用通用方案或采购。  
**通用子域**：跟踪与安全 —— 更偏运维/安全工具，易被替换或外包。

---

## 三、为啥这么划分？

### 3.1 按「业务内聚 + Kamailio 模块」聚类

- 当前 6 个模块的划分，本质是**按 Kamailio 功能域聚类**，而不是按技术层（api/service/dal）拆分：
  - **routing**：所有与「路由、调度、拨号计划」相关的 RPC 与表归在一起，变更时影响面集中。
  - **session**：dialog / htable / location 都围绕「会话与位置状态」，读写模型接近。
  - **user / monitor / presence / trace**：同理，各管一块 Kamailio 能力，边界清晰。
- **好处**：与 Kamailio 官方模块概念一致，RPC 与数据模型一一对应；团队可「按域」分工；构建与测试可只编/测某一域。

### 3.2 核心域为何是「路由 + 会话」？

- **路由与调度**：直接决定话务走向、负载均衡与拨号逻辑，是运营商/企业最关心的「配置中枢」。
- **会话与位置**：决定当前有哪些会话、用户注册在哪，是实时状态与故障排查的基础。
- 二者构成「**编排与状态可见性**」，是 kam-admin 区别于「简单 RPC 代理」的关键，故标为核心域。

### 3.3 用户/监控/状态/跟踪的归类

- **用户与权限**：支撑「多租户、多角色、谁能操作什么」，是支撑子域；未来可对接统一身份或 IdP，仍属支撑。
- **监控与统计**：支撑「可观测、计费、排障」，必要但非差异化；未来若有独立告警/计费服务，可仍由该子域提供数据或接口。
- **状态与消息**：若产品不强调「在线状态/消息中心」，可视为通用；若强调，可提升为支撑子域。
- **跟踪与安全**：运维与安全能力，偏通用；若要做「安全策略引擎」等差异化，可再拆或升级。

---

## 四、是否考虑了当前与未来规划？

### 4.1 当前实现

- **已落地**：6 个领域模块（user, routing, session, monitor, presence, trace）与设计文档中的「思路二：按领域/功能域拆」一致。
- **依赖关系**：各领域模块只依赖 **kam-admin-common**；**kam-admin-server** 依赖 6 个领域模块，做启动、配置、RPC 实现、鉴权、租户、开放 API。无循环依赖，符合「按域独立演进、按需单独编/测」的目标。

### 4.2 设计文档中已体现的前瞻

- **按域独立成服务**：设计文档明确「若某领域要独立交付或多人并行开发，再按思路二把该领域拆成 kam-admin-module-xxx」；当前拆法天然支持「将来把某个 module 单独打成服务或 SDK」。
- **多租户**：租户与 RPC/数据源绑定（见 `architecture-multi-tenancy.md`）；用户与权限域（module-user）与租户、鉴权紧密相关，边界清晰便于扩展「租户级权限/配额」。
- **开放 API**：若引入「思路三」的 api/service 分层，当前 6 域可作为 service 层按域组织，api 层再按需聚合或暴露。

### 4.3 未来可扩展点（仍落在当前子域内）

| 方向 | 涉及子域 | 说明 |
|------|----------|------|
| 多租户深化（配额、计费策略） | user + monitor | 在 user 做租户/权限扩展，在 monitor 做 acc/计费策略或与外部计费对接 |
| 策略引擎 / 路由策略配置化 | routing | 在 routing 域内增加「策略规则引擎」或配置化路由，不新增子域 |
| 独立监控/告警服务 | monitor | 可将 monitor 模块单独部署为监控微服务，或只暴露接口给告警系统 |
| 安全策略与审计 | trace + user | trace 负责 secfilter/siptrace，user 负责审计日志与权限，可协同扩展 |
| 新 Kamailio 模块接入 | 按能力归入现有 6 域之一，或新域 | 新模块按「路由/会话/监控/状态/安全」归类；若出现全新能力域，再考虑新增子域（如「策略域」） |

---

## 五、小结

- **子域数量与命名**：建议保持当前 **6 个子域**（路由、会话、用户、监控、状态、跟踪），并与 6 个 Maven 模块一一对应；从 DDD 上明确**核心域 = routing + session**，其余为支撑/通用，便于排优先级。
- **划分理由**：按业务内聚与 Kamailio 模块聚类，边界清晰、易与 RPC/数据对应，且便于按域分工和独立演进。
- **当前与未来**：当前实现已按该划分落地；设计文档和架构（多租户、开放 API、按域拆服务）已为「未来按域独立部署、多租户深化、开放 API」留出空间；后续若出现全新能力线，再考虑新增子域或对现有域做升级（支撑↔核心）。

如需在代码或包名中显式体现「核心域」，可在文档与注释中标注 **routing / session** 为核心域，或在迭代规划中优先分配资源给这两块。
